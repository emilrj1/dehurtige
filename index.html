<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hurtigste Scootere ‚Äì Leaderboard</title>
  <meta name="description" content="Leaderboard over de hurtigste scootere. Data i Firebase. Kun admin kan tilf√∏je/slette. Alle loggede brugere kan like (√©t like pr. bruger)." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,0.08); }
    .hidden { display: none; }
    .btn { @apply rounded-xl border border-zinc-700 px-3 py-2 hover:border-zinc-500; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-zinc-950 via-zinc-900 to-zinc-950 text-zinc-100">
  <!-- Header -->
  <header class="sticky top-0 z-30 border-b border-zinc-800/80 bg-zinc-950/70 glass">
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center gap-3">
      <img src="/logo.png" onerror="this.style.display='none'" class="h-8 w-8 rounded-lg ring-1 ring-zinc-800" alt="Logo" />
      <div class="text-xl font-extrabold tracking-tight">Scooter Leaderboard</div>
      <div class="ml-auto flex items-center gap-2">
        <span id="adminBadge" class="text-xs rounded-full border border-emerald-700/70 px-2 py-1 text-emerald-300 hidden">ADMIN</span>
        <button id="langBtn" class="px-3 py-1.5 text-sm rounded-xl border border-zinc-700 hover:border-zinc-500 transition" title="Skift sprog">DA</button>
        <button id="googleLoginBtn" class="px-3 py-1.5 text-sm rounded-xl border border-zinc-700 hover:border-zinc-500 transition" data-i18n="login">Login (Google)</button>
        <button id="adminLoginBtn" class="px-3 py-1.5 text-sm rounded-xl border border-zinc-700 hover:border-zinc-500 transition" title="Kun til admin fallback (email/password)">Admin login</button>
        <button id="logoutBtn" class="px-3 py-1.5 text-sm rounded-xl border border-zinc-700 hover:border-zinc-500 transition hidden" data-i18n="logout">Log ud</button>
        <button id="exportBtn" class="px-3 py-1.5 text-sm rounded-xl border border-zinc-700 hover:border-zinc-500 transition" title="Download JSON (alle kan eksportere)">Export JSON</button>
        <label id="importLabel" class="px-3 py-1.5 text-sm rounded-xl border border-zinc-700 hover:border-zinc-500 transition cursor-pointer hidden">
          Import JSON
          <input id="importInput" type="file" accept="application/json" class="hidden" />
        </label>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="mx-auto max-w-6xl px-4 py-8">
    <!-- Hero / Controls -->
    <section class="mb-8 grid gap-6 md:grid-cols-3">
      <div class="md:col-span-2 p-5 rounded-2xl border border-zinc-800 bg-zinc-900/40">
        <h1 class="text-2xl md:text-3xl font-black mb-2">De hurtigste scootere</h1>
        <p class="text-zinc-300" data-i18n="hero">Her kan du se <span class="font-semibold">de hurtigeste</span> knallerter!</p>
        <div class="mt-4 flex flex-wrap items-center gap-3">
          <div class="flex items-center gap-2 text-sm">
            <span class="inline-block h-2 w-2 rounded-full bg-emerald-500"></span> <span data-i18n="verified">Verificeret bevis</span>
          </div>
          <div class="flex items-center gap-2 text-sm">
            <span class="inline-block h-2 w-2 rounded-full bg-yellow-500"></span> <span data-i18n="unverified">Link mangler / uverificeret</span>
          </div>
        </div>
      </div>
      <div class="p-5 rounded-2xl border border-zinc-800 bg-zinc-900/40">
        <label class="block text-sm font-semibold mb-1" for="search" data-i18n="searchLabel">S√∏g</label>
        <input id="search" type="text" class="w-full rounded-xl border border-zinc-700 bg-zinc-950 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-zinc-500" data-i18n-ph="searchPh" placeholder="S√∏g p√• f√∏rer, scooter, HK, lokation..." />
        <div class="mt-3 grid grid-cols-3 gap-2 text-sm">
          <button id="sortSpeedBtn" class="rounded-xl border border-zinc-700 px-3 py-2 hover:border-zinc-500" data-i18n="sortSpeed">Sort√©r: Fart ‚Üì</button>
          <button id="sortLikesBtn" class="rounded-xl border border-zinc-700 px-3 py-2 hover:border-zinc-500" data-i18n="sortLikes">Sort√©r: Likes</button>
          <button id="clearBtn" class="rounded-xl border border-zinc-700 px-3 py-2 hover:border-zinc-500 hidden" data-i18n="clearAll">Ryd alt (admin)</button>
        </div>
      </div>
    </section>

    <!-- Table -->
    <section class="mb-8 overflow-hidden rounded-2xl border border-zinc-800">
      <div class="overflow-x-auto">
        <table class="min-w-full bg-zinc-900/30">
          <thead class="bg-zinc-900/60">
            <tr class="text-left text-sm uppercase tracking-wide text-zinc-300">
              <th class="px-4 py-3">#</th>
              <th class="px-4 py-3" data-i18n="rider">F√∏rer</th>
              <th class="px-4 py-3" data-i18n="scooter">Scooter</th>
              <th class="px-4 py-3">HK</th>
              <th class="px-4 py-3" data-i18n="speedometer">Speedometer</th>
              <th class="px-4 py-3 cursor-pointer" id="speedHeader" title="Klik for at sortere" data-i18n="topspeed">Topfart (km/t)</th>
              <th class="px-4 py-3" data-i18n="likes">Likes</th>
              <th class="px-4 py-3" data-i18n="evidence">Bevis</th>
              <th class="px-4 py-3" data-i18n="location">Lokation</th>
              <th class="px-4 py-3" data-i18n="action">Handling</th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y divide-zinc-800"></tbody>
        </table>
      </div>
    </section>

    <!-- Add Entry Form (admin only) -->
    <section id="adminFormSection" class="mb-16 p-5 rounded-2xl border border-zinc-800 bg-zinc-900/40 hidden">
      <h2 class="text-xl font-bold mb-3" data-i18n="addTitle">Tilf√∏j ny rekord (admin)</h2>
      <form id="addForm" class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold mb-1" for="rider" data-i18n="riderReq">F√∏rer *</label>
          <input id="rider" required class="w-full rounded-xl border border-zinc-700 bg-zinc-950 px-3 py-2" data-i18n-ph="riderPh" placeholder="Navn eller nick" />
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1" for="scooter" data-i18n="scooterReq">Scooter *</label>
          <input id="scooter" required class="w-full rounded-xl border border-zinc-700 bg-zinc-950 px-3 py-2" data-i18n-ph="scooterPh" placeholder="Model (fx PGO Hot 50)" />
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1" for="hk">HK</label>
          <input id="hk" type="number" min="1" max="100" step="0.1" class="w-full rounded-xl border border-zinc-700 bg-zinc-950 px-3 py-2" data-i18n-ph="hkPh" placeholder="fx 12.5" />
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1" for="speed" data-i18n="topspeedReq">Topfart (km/t) *</label>
          <input id="speed" type="number" min="1" max="400" step="0.1" required class="w-full rounded-xl border border-zinc-700 bg-zinc-950 px-3 py-2" data-i18n-ph="speedPh" placeholder="fx 112.5" />
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1" for="evidence" data-i18n="evidenceLink">Bevis-link</label>
          <input id="evidence" type="url" class="w-full rounded-xl border border-zinc-700 bg-zinc-950 px-3 py-2" data-i18n-ph="evidencePh" placeholder="YouTube, GPS-log, billede..." />
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1" for="location" data-i18n="locationLabel">Lokation</label>
          <input id="location" class="w-full rounded-xl border border-zinc-700 bg-zinc-950 px-3 py-2" data-i18n-ph="locationPh" placeholder="By / str√¶kning" />
        </div>
        <div class="flex items-end">
          <button class="w-full rounded-xl border border-zinc-700 bg-zinc-950 px-3 py-2 hover:border-zinc-500" data-i18n="addBtn">Tilf√∏j</button>
        </div>
      </form>
      <p class="text-xs text-zinc-400 mt-3" data-i18n="adminNote">* Kun admin kan tilf√∏je. Misbrug (fake tider) kan fjernes af admin.</p>
    </section>

    <!-- Footer -->
    <footer class="pb-12 text-center text-sm text-zinc-400">
      Lavet af Lean.
    </footer>
  </main>

  <script type="module">
    // ===== Firebase setup =====
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, getDocs, getCountFromServer } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    // 1) Udfyld denne config fra dit Firebase-projekt
    const firebaseConfig = {
      apiKey: "AIzaSyCTd9LEy6TJI5ktK6r_Pn1jiahbB-rl4-0",
      authDomain: "scooter-f404c.firebaseapp.com",
      databaseURL: "https://scooter-f404c-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "scooter-f404c",
      storageBucket: "scooter-f404c.firebasestorage.app",
      messagingSenderId: "717023125803",
      appId: "1:717023125803:web:59a76dbc983e2ead43656e",
      measurementId: "G-9CTP8W3SSJ"
    };

    const ADMIN_UID = 'DMckhIoixhhMaHs4NNybD7YH9W12';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();

    // ===== UI State =====
    let adminMode = false;
    let sortDesc = true;
    let sortByLikes = false;
    let lang = localStorage.getItem('lang') || 'da';

    /** @type {Array<{id:string,rider:string,scooter:string,hk:number,speed:number,evidence?:string,location?:string,created:number,_likes?:number}>} */
    let entries = [];

    // ===== i18n =====
    const T = {
      da: {
        login: 'Login (Google)', logout: 'Log ud', hero: 'Her kan du se <span class="font-semibold">de hurtigeste</span> knallerter!', verified:'Verificeret bevis', unverified:'Link mangler / uverificeret', searchLabel:'S√∏g', searchPh:'S√∏g p√• f√∏rer, scooter, HK, lokation...', sortSpeed:'Sort√©r: Fart ‚Üì', sortLikes:'Sort√©r: Likes', clearAll:'Ryd alt (admin)', rider:'F√∏rer', scooter:'Scooter', speedometer:'Speedometer', topspeed:'Topfart (km/t)', likes:'Likes', evidence:'Bevis', location:'Lokation', action:'Handling', addTitle:'Tilf√∏j ny rekord (admin)', riderReq:'F√∏rer *', riderPh:'Navn eller nick', scooterReq:'Scooter *', scooterPh:'Model (fx PGO Hot 50)', hkPh:'fx 12.5', topspeedReq:'Topfart (km/t) *', speedPh:'fx 112.5', evidenceLink:'Bevis-link', evidencePh:'YouTube, GPS-log, billede...', locationLabel:'Lokation', locationPh:'By / str√¶kning', addBtn:'Tilf√∏j'
      },
      en: {
        login: 'Login (Google)', logout: 'Log out', hero: 'See the <span class="font-semibold">fastest</span> mopeds here!', verified:'Verified proof', unverified:'No link / unverified', searchLabel:'Search', searchPh:'Search rider, scooter, HP, location...', sortSpeed:'Sort: Speed ‚Üì', sortLikes:'Sort: Likes', clearAll:'Clear all (admin)', rider:'Rider', scooter:'Scooter', speedometer:'Speedometer', topspeed:'Top speed (km/h)', likes:'Likes', evidence:'Proof', location:'Location', action:'Action', addTitle:'Add new record (admin)', riderReq:'Rider *', riderPh:'Name or nick', scooterReq:'Scooter *', scooterPh:'Model (e.g. PGO Hot 50)', hkPh:'e.g. 12.5', topspeedReq:'Top speed (km/h) *', speedPh:'e.g. 112.5', evidenceLink:'Proof link', evidencePh:'YouTube, GPS log, photo...', locationLabel:'Location', locationPh:'City / stretch', addBtn:'Add'
      }
    };

    function applyI18n() {
      const dict = T[lang];
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k = el.getAttribute('data-i18n');
        if (dict[k]) el.innerHTML = dict[k];
      });
      document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
        const k = el.getAttribute('data-i18n-ph');
        if (dict[k]) el.setAttribute('placeholder', dict[k]);
      });
      document.getElementById('langBtn').textContent = lang.toUpperCase();
    }

    // ===== Realtime: entries =====
    const entriesRef = collection(db, 'entries');
    const qSpeed = query(entriesRef, orderBy('speed', 'desc'));
    onSnapshot(qSpeed, async (snapshot) => {
      entries = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      await refreshAllLikeCounts();
      renderTable(document.getElementById('search').value);
    });

    async function refreshAllLikeCounts() {
      const tasks = entries.map(async (e) => {
        try {
          const likesCol = collection(db, 'entries', e.id, 'likes');
          const agg = await getCountFromServer(likesCol);
          e._likes = agg.data().count || 0;
        } catch { e._likes = 0; }
      });
      await Promise.all(tasks);
    }

    // ===== Auth =====
    onAuthStateChanged(auth, (user) => setAuthUi(user));

    document.getElementById('googleLoginBtn').addEventListener('click', async () => {
      try { await signInWithPopup(auth, googleProvider); } catch (err) { alert('Google login fejlede: ' + (err?.message||err)); }
    });

    document.getElementById('adminLoginBtn').addEventListener('click', async () => {
      const email = prompt('Admin e-mail:');
      if (!email) return;
      const pass = prompt('Adgangskode:');
      if (pass === null) return;
      try { await signInWithEmailAndPassword(auth, email, pass); } catch (err) { alert('Login fejlede: ' + (err?.message || err)); }
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => { try { await signOut(auth); } catch (e) {} });

    document.getElementById('langBtn').addEventListener('click', () => {
      lang = (lang === 'da') ? 'en' : 'da';
      localStorage.setItem('lang', lang);
      applyI18n();
      renderTable(document.getElementById('search').value);
    });

    function setAdminUi(on) {
      adminMode = !!on;
      document.getElementById('adminBadge').classList.toggle('hidden', !adminMode);
      document.getElementById('adminLoginBtn').classList.toggle('hidden', adminMode);
      document.getElementById('importLabel').classList.toggle('hidden', !adminMode);
      document.getElementById('clearBtn').classList.toggle('hidden', !adminMode);
      document.getElementById('adminFormSection').classList.toggle('hidden', !adminMode);
      renderTable(document.getElementById('search').value);
    }

    function setAuthUi(user) {
      const loggedIn = !!user;
      document.getElementById('googleLoginBtn').classList.toggle('hidden', loggedIn);
      document.getElementById('logoutBtn').classList.toggle('hidden', !loggedIn);
      setAdminUi(loggedIn && user.uid === ADMIN_UID);
    }

    // ===== Helpers =====
    function escapeHtml(str) { return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s])); }
    function escapeAttr(str) { return String(str).replace(/"/g,'&quot;'); }
    function isTrustedLink(url) { try { const u = new URL(url); const trustedHosts = ['youtube.com','youtu.be','drive.google.com','imgur.com','gyazo.com','strava.com','garmin.com']; return trustedHosts.some(h => u.hostname.endsWith(h)); } catch { return false; } }

    // ===== Like helpers =====
    async function hasUserLiked(entryId) {
      const user = auth.currentUser; if (!user) return false;
      const likeDocRef = doc(db, 'entries', entryId, 'likes', user.uid);
      try {
        const snap = await (await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js')).getDoc(likeDocRef);
        return snap.exists();
      } catch { return false; }
    }

    async function toggleLike(entryId, btnEl) {
      const user = auth.currentUser;
      if (!user) { alert(lang==='da'?'Log ind med Google for at like.':'Log in with Google to like.'); return; }
      const likeDocRef = doc(db, 'entries', entryId, 'likes', user.uid);
      const { setDoc, deleteDoc: delDoc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
      try {
        const cur = await getDoc(likeDocRef);
        if (cur.exists()) {
          await delDoc(likeDocRef);
        } else {
          await setDoc(likeDocRef, { uid: user.uid, created: Date.now() });
        }
        await refreshAllLikeCounts();
        updateLikeButtonState(entryId, btnEl);
      } catch (err) {
        alert((lang==='da'?'Kunne ikke opdatere like: ':'Could not update like: ') + (err?.message||err));
      }
    }

    async function updateLikeButtonState(entryId, btnEl) {
      const liked = await hasUserLiked(entryId);
      const item = entries.find(x => x.id === entryId);
      const count = item?._likes ?? 0;
      btnEl.dataset.liked = liked ? '1' : '0';
      btnEl.innerHTML = liked
        ? `‚ù§Ô∏è <span class="tabular-nums">${count}</span>`
        : `ü§ç <span class="tabular-nums">${count}</span>`;
      btnEl.title = liked ? (lang==='da'?'Fjern like':'Remove like') : (lang==='da'?'Giv like':'Give like');
    }

    // ===== Speedometer (SVG) =====
    function speedometerSvg(speed, maxSpeed) {
      const radius = 22;
      const circumference = 2 * Math.PI * radius;
      const pct = Math.max(0, Math.min(1, speed / maxSpeed));
      const id = 'g' + Math.random().toString(36).slice(2);
      return `
        <svg viewBox="0 0 60 60" width="60" height="60">
          <circle cx="30" cy="30" r="${radius}" stroke="#27272a" stroke-width="6" fill="none" />
          <circle id="${id}" cx="30" cy="30" r="${radius}" stroke="#10b981" stroke-width="6" fill="none" stroke-linecap="round" stroke-dasharray="${circumference}" stroke-dashoffset="${circumference}" transform="rotate(-90 30 30)" />
          <text x="30" y="34" text-anchor="middle" font-size="12" fill="#e5e7eb" font-weight="700">${Math.round(speed)}</text>
        </svg>`;
    }

    function animateGauge(el, targetPct) {
      const circle = el.querySelector('circle[stroke="#10b981"]');
      if (!circle) return;
      const r = parseFloat(circle.getAttribute('r'));
      const C = 2*Math.PI*r;
      let p = 0;
      const step = () => {
        p += (targetPct - p) * 0.1;
        const off = C * (1 - p);
        circle.setAttribute('stroke-dashoffset', String(off));
        if (Math.abs(targetPct - p) > 0.001) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    }

    // ===== Table render =====
    function renderTable(filter = '') {
      applyI18n();
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';

      let data = [...entries];
      if (sortByLikes) data.sort((a,b)=> (b._likes||0) - (a._likes||0));
      else data.sort((a,b)=> sortDesc ? b.speed - a.speed : a.speed - b.speed);

      const q = (filter||'').trim().toLowerCase();
      if (q) {
        data = data.filter(e => (
          (e.rider||'').toLowerCase().includes(q) ||
          (e.scooter||'').toLowerCase().includes(q) ||
          String(e.hk||'').toLowerCase().includes(q) ||
          (e.location||'').toLowerCase().includes(q)
        ));
      }

      const maxSpeed = Math.max(1, ...data.map(e=>Number(e.speed)||0));

      data.forEach((e, idx) => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-zinc-900/40';
        const actionDel = adminMode
          ? `<button data-id="${e.id}" class="delBtn text-xs rounded-lg border border-red-800/70 px-2 py-1 text-red-300 hover:bg-red-900/30">${lang==='da'?'Slet':'Delete'}</button>`
          : '<span class="text-zinc-500 text-xs">‚Äî</span>';
        const likeBtnId = `like-${e.id}`;
        const gaugeHtml = speedometerSvg(Number(e.speed)||0, maxSpeed);
        tr.innerHTML = `
          <td class="px-4 py-3 text-zinc-400">${idx+1}</td>
          <td class="px-4 py-3 font-medium">${escapeHtml(e.rider||'')}</td>
          <td class="px-4 py-3">${escapeHtml(e.scooter||'')}</td>
          <td class="px-4 py-3 text-zinc-300">${e.hk ? Number(e.hk).toFixed(1) : '‚Äî'}</td>
          <td class="px-4 py-3">${gaugeHtml}</td>
          <td class="px-4 py-3 font-semibold">${Number(e.speed||0).toFixed(1)}</td>
          <td class="px-4 py-3">
            <button id="${likeBtnId}" class="text-xs rounded-lg border border-zinc-700 px-2 py-1 hover:bg-zinc-900/40">ü§ç <span class="tabular-nums">${e._likes||0}</span></button>
          </td>
          <td class="px-4 py-3">
            ${e.evidence ? `<a href="${escapeAttr(e.evidence)}" target="_blank" class="inline-flex items-center gap-2 rounded-full border px-2.5 py-1 text-xs ${isTrustedLink(e.evidence) ? 'border-emerald-700 text-emerald-300' : 'border-yellow-700 text-yellow-300'} hover:underline">${isTrustedLink(e.evidence) ? (lang==='da'?'Verificeret':'Verified') : (lang==='da'?'Uverificeret':'Unverified')}</a>` : '<span class="text-zinc-500 text-xs">‚Äî</span>'}
          </td>
          <td class="px-4 py-3">${escapeHtml(e.location||'')}</td>
          <td class="px-4 py-3">${actionDel}</td>
        `;
        tbody.appendChild(tr);

        const likeBtn = document.getElementById(likeBtnId);
        likeBtn.addEventListener('click', () => toggleLike(e.id, likeBtn));
        updateLikeButtonState(e.id, likeBtn);
        // animate gauge
        const svgEl = tr.querySelector('svg');
        const pct = Math.max(0, Math.min(1, (Number(e.speed)||0) / maxSpeed));
        animateGauge(svgEl, pct);
      });

      if (adminMode) {
        document.querySelectorAll('.delBtn').forEach(btn => {
          btn.addEventListener('click', async (ev) => {
            const id = ev.currentTarget.getAttribute('data-id');
            if (!adminMode) return;
            if (!confirm(lang==='da'?'Slet denne rekord?':'Delete this record?')) return;
            try { await deleteDoc(doc(db, 'entries', id)); } catch (err) { alert((lang==='da'?'Kunne ikke slette: ':'Could not delete: ') + (err?.message||err)); }
          });
        });
      }
    }

    // ===== Form & controls =====
    document.getElementById('addForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!adminMode) { alert(lang==='da'?'Kun admin kan tilf√∏je.':'Only admin can add.'); return; }
      const rider = document.getElementById('rider').value.trim();
      const scooter = document.getElementById('scooter').value.trim();
      const hkVal = parseFloat(document.getElementById('hk').value);
      const speed = parseFloat(document.getElementById('speed').value);
      const evidence = document.getElementById('evidence').value.trim();
      const location = document.getElementById('location').value.trim();

      if (!rider || !scooter || !Number.isFinite(speed)) { alert(lang==='da'?'Udfyld F√∏rer, Scooter og Topfart.':'Fill Rider, Scooter and Top speed.'); return; }
      if (speed <= 0 || speed > 400) { alert(lang==='da'?'Topfart ser forkert ud (1‚Äì400 km/t).':'Top speed looks wrong (1‚Äì400 km/h).'); return; }
      if (evidence && !isValidUrl(evidence)) { alert(lang==='da'?'Bevis-linket er ikke en gyldig URL.':'Proof link is not a valid URL.'); return; }

      const payload = { rider, scooter, speed: Number(speed), evidence, location, created: Date.now() };
      if (Number.isFinite(hkVal)) payload.hk = Number(hkVal);

      try {
        await addDoc(entriesRef, payload);
        (e.target).reset();
      } catch (err) { alert((lang==='da'?'Kunne ikke gemme: ':'Could not save: ')+(err?.message||err)); }
    });

    function isValidUrl(u) { try { new URL(u); return true; } catch { return false; } }

    document.getElementById('sortSpeedBtn').addEventListener('click', () => {
      sortByLikes = false;
      sortDesc = !sortDesc;
      document.getElementById('sortSpeedBtn').textContent = (lang==='da'?'Sort√©r: Fart ':'Sort: Speed ') + (sortDesc ? '‚Üì' : '‚Üë');
      renderTable(document.getElementById('search').value);
    });
    document.getElementById('sortLikesBtn').addEventListener('click', () => {
      sortByLikes = true;
      renderTable(document.getElementById('search').value);
    });
    document.getElementById('speedHeader').addEventListener('click', () => {
      sortByLikes = false; sortDesc = !sortDesc; renderTable(document.getElementById('search').value);
    });
    document.getElementById('search').addEventListener('input', (e) => { renderTable(e.target.value); });

    document.getElementById('clearBtn').addEventListener('click', async () => {
      if (!adminMode) return;
      if (!confirm(lang==='da'?'SLET ALT? Dette fjerner alle rekorder i Firebase.':'DELETE ALL? This will remove all records in Firebase.')) return;
      try {
        const snap = await getDocs(entriesRef);
        await Promise.all(snap.docs.map(d => deleteDoc(doc(db, 'entries', d.id))));
      } catch (err) { alert((lang==='da'?'Kunne ikke rydde alt: ':'Could not clear all: ') + (err?.message||err)); }
    });

    document.getElementById('exportBtn').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(entries, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'scooter-leaderboard.json'; a.click();
      setTimeout(() => URL.revokeObjectURL(url), 5000);
    });

    document.getElementById('importInput').addEventListener('change', async (ev) => {
      if (!adminMode) { alert(lang==='da'?'Kun admin kan importere.':'Only admin can import.'); ev.target.value=''; return; }
      const file = ev.target.files?.[0]; if (!file) return;
      const text = await file.text();
      try {
        const data = JSON.parse(text);
        if (!Array.isArray(data)) throw new Error('JSON skal v√¶re en liste.');
        for (const x of data) {
          const item = {
            rider: String(x.rider||'Ukendt'),
            scooter: String(x.scooter||'Ukendt'),
            hk: Number(x.hk||NaN),
            speed: Number(x.speed||0),
            evidence: x.evidence ? String(x.evidence) : '',
            location: x.location ? String(x.location) : '',
            created: Number(x.created || Date.now())
          };
          if (!Number.isFinite(item.hk)) delete item.hk;
          if (Number.isFinite(item.speed) && item.speed>0) {
            await addDoc(entriesRef, item);
          }
        }
      } catch (err) {
        alert((lang==='da'?'Kunne ikke importere JSON: ':'Could not import JSON: ') + err.message);
      } finally { ev.target.value = ''; }
    });

    // init
    applyI18n();
  </script>

  <!-- Firestore Rules (kopi√©r til Firestore Rules i Firebase Console)
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /entries/{doc} {
        allow read: if true;
        allow write: if request.auth != null && request.auth.uid == 'YOUR_ADMIN_UID';
        match /likes/{uid} {
          allow read: if true;
          allow create, delete: if request.auth != null && request.auth.uid == uid;
          allow update: if false;
        }
      }
    }
  }
  -->
  
</body>
</html>
